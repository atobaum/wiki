<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width"><title>Atobaum Wiki</title><link rel=stylesheet href=https://atobaum.github.io/css/index.css><link rel=stylesheet href=https://atobaum.github.io/css/reset.css><link rel=apple-touch-icon sizes=180x180 href=https://atobaum.github.io/fav/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://atobaum.github.io/fav/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://atobaum.github.io/fav/favicon-16x16.png><link rel=manifest href=https://atobaum.github.io/fav/site.webmanifest><script async src="https://www.googletagmanager.com/gtag/js?id=UA-177439615-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-177439615-1');</script></head><body><div id=wrap><header id=gheader><div class="flex flex-jsb"><div id=logo><a href=https://atobaum.github.io>Atobaum Wiki</a></div><nav class=right0><ul id=gnb><li><a href=/about>about</a></li><li><a href=/>all</a></li><li><a href=/random>random</a></li><li><a href=/tags>tags</a></li></ul></nav></div><div id=search class=flex-end>searchbar</div></header><div id=main><h1 class=content-title>웹소켓에 대한 소고</h1><h3 class=content-summary>웹소켓을 알아보자</h3><div><div><ul class=tag-list><li class=tag><a href=https://atobaum.github.io/tags/web>#Web</a></li><li class=tag><a href=https://atobaum.github.io/tags/web-socket>#Web Socket</a></li></ul></div><div class=content-meta><ul><li>작성: 2020-09-23<li></li>수정: 2020-09-23</li></ul>2 분 걸려요.</div><div><aside id=toc-wrapper><nav id=TableOfContents><ul><li><ul><li><a href=#개요>개요</a></li><li><a href=#subprotocol>Subprotocol</a></li><li><a href=#브라우저에서-사용해보자>브라우저에서 사용해보자</a><ul><li><a href=#연결하기>연결하기</a></li><li><a href=#전송하기>전송하기</a></li><li><a href=#전송-받기>전송 받기</a></li><li><a href=#연결-끊기>연결 끊기</a></li><li><a href=#핸들러>핸들러</a></li></ul></li><li><a href=#node로-서버-구현>Node로 서버 구현</a></li><li><a href=#example>Example</a></li><li><a href=#reference>Reference</a></li></ul></li></ul></nav></aside><article class=content-article><h2 id=개요>개요</h2><p>웹소켓은 먼저 HTTP로 handshake를 한다.</p><p>클라이언트는 먼저 HTTP 요청을 서버로 보내 프로토콜을 websocket으로 바꾸기를 요청한다:</p><div class=highlight><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=color:#268bd2>GET</span> <span style=color:#268bd2>/chat</span> <span style=color:#859900>HTTP</span>/<span style=color:#2aa198;font-weight:700>1.1</span>
<span style=color:#268bd2>Host</span>: <span style=color:#2aa198>example.com:8000</span>
<span style=color:#268bd2>Upgrade</span>: <span style=color:#2aa198>websocket</span>
<span style=color:#268bd2>Connection</span>: <span style=color:#2aa198>Upgrade</span>
<span style=color:#268bd2>Sec-WebSocket-Key</span>: <span style=color:#2aa198>dGhlIHNhbXBsZSBub25jZQ==</span>
<span style=color:#268bd2>Sec-WebSocket-Version</span>: <span style=color:#2aa198>13</span>

</code></pre></div><p>이때 <code>Sec-WebSocket-Key</code>는 서버와 웹소켓 악수(handshake)를 정상적으로 하기 위한 값이다. 이 값은 클라이언트에서 랜덤으로 만든 16 byte 값을 base64로 인코딩 한 것이다.</p><p>서버는 요청을 검증하고 다음 응답을 보낸다.</p><div class=highlight><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-http data-lang=http><span style=color:#859900>HTTP</span>/<span style=color:#2aa198;font-weight:700>1.1</span> <span style=color:#2aa198;font-weight:700>101</span> <span style=color:#268bd2>Switching Protocols</span>
<span style=color:#268bd2>Upgrade</span>: <span style=color:#2aa198>websocket</span>
<span style=color:#268bd2>Connection</span>: <span style=color:#2aa198>Upgrade</span>
<span style=color:#268bd2>Sec-WebSocket-Accept</span>: <span style=color:#2aa198>s3pPLMBiTxaQ9kYGzzhZRbK+xOo=</span>

</code></pre></div><p>서버가 보내는 <code>Sec-WebSocket-Accept</code>는 클라이언트의 <code>Sec-WebSocket-Key</code>에다가 <code>258EAFA5-E914-47DA-95CA-C5AB0DC85B11</code>를 연결(문자열로)하고 SHA-1 해시값을 base64로 인코딩한 값이다.</p><p>이 값은 클라이언트가 웹소켓을 지원하지 않는 서버에 연결한 것으로 착각하는 것을 막기 위한 값이다.</p><p><img src=/images/chatting-with-websocket/request-example.jpg alt="요청 예시"></p><ul><li>요청 예시</li></ul><h2 id=subprotocol>Subprotocol</h2><p>웹소켓은 subprotocol을 가질 수 있다. 클라이언트가 요청 시 <code>Sec-WebSocket-Protocol</code> 헤더이 지정하면(comma-seperated list) 서버는 그에 따라 적절하게 처리할 수 있다.</p><h2 id=브라우저에서-사용해보자>브라우저에서 사용해보자</h2><h3 id=연결하기>연결하기</h3><div class=highlight><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#859900>let</span> <span style=color:#268bd2>ws</span> = <span style=color:#859900>new</span> <span style=color:#268bd2>WebSocket</span>(<span style=color:#2aa198>&#34;ws://localhost:3000&#34;</span>);
<span style=color:#859900>let</span> <span style=color:#268bd2>ws</span> = <span style=color:#859900>new</span> <span style=color:#268bd2>WebSocket</span>(<span style=color:#2aa198>&#34;ws://localhost:3000&#34;</span>, <span style=color:#2aa198>&#34;echo&#34;</span>); <span style=color:#93a1a1;font-style:italic>// 프로토콜을 줄 수 있다.
</span><span style=color:#93a1a1;font-style:italic></span><span style=color:#859900>let</span> <span style=color:#268bd2>ws</span> = <span style=color:#859900>new</span> <span style=color:#268bd2>WebSocket</span>(<span style=color:#2aa198>&#34;ws://localhost:3000&#34;</span>, [<span style=color:#2aa198>&#34;echo&#34;</span>, <span style=color:#2aa198>&#34;chat&#34;</span>]); <span style=color:#93a1a1;font-style:italic>// 여러개 줄 수도 있다.
</span></code></pre></div><p>WebSocket은 <code>CONNECTING, OPEN, CLOSING, CLOSED</code>의 네가지 상태를 가지고 있고 값은 <code>WebSocket.&lt;status></code>에 정의되어있다.</p><p>연결이 되면 <code>OPEN</code> 상태로 바뀌고 그때부터 메시지를 전송할 수 있다.
ws.readystate로 현재 상태를 알 수 있다.</p><h3 id=전송하기>전송하기</h3><div class=highlight><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#268bd2>ws</span>.<span style=color:#268bd2>send</span>(<span style=color:#2aa198>&#34;message&#34;</span>);
</code></pre></div><p>보낼 수 있는 데이터는 String, Blob, ArrayBuffer로 JSON을 보내려면 stringify 해서 보내면 된다.</p><h3 id=전송-받기>전송 받기</h3><div class=highlight><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#268bd2>ws</span>.<span style=color:#268bd2>onmessage</span> = (<span style=color:#268bd2>evt</span>) =&gt; {
	<span style=color:#268bd2>console</span>.<span style=color:#268bd2>log</span>(<span style=color:#268bd2>evt</span>.<span style=color:#268bd2>data</span>);
}
</code></pre></div><h3 id=연결-끊기>연결 끊기</h3><div class=highlight><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#268bd2>ws</span>.<span style=color:#268bd2>close</span>();
</code></pre></div><h3 id=핸들러>핸들러</h3><p>WebSocket은 <code>onopen, onclose, onerror, onmessage</code> 핸들러를 가질 수 있다.</p><h2 id=node로-서버-구현>Node로 서버 구현</h2><p>많은 코드가 생략되었습니다.</p><div class=highlight><pre style=color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#859900>var</span> <span style=color:#268bd2>http</span> = <span style=color:#268bd2>require</span>(<span style=color:#2aa198>&#34;http&#34;</span>);
<span style=color:#859900>var</span> <span style=color:#268bd2>webSocketServer</span> = <span style=color:#268bd2>require</span>(<span style=color:#2aa198>&#34;websocket&#34;</span>).<span style=color:#268bd2>server</span>;

<span style=color:#859900>var</span> <span style=color:#268bd2>connections</span> = [];
<span style=color:#859900>var</span> <span style=color:#268bd2>server</span> = <span style=color:#268bd2>http</span>.<span style=color:#268bd2>createServer</span>();
<span style=color:#859900>var</span> <span style=color:#268bd2>wsServer</span> = <span style=color:#859900>new</span> <span style=color:#268bd2>webSocketServer</span>({
  <span style=color:#268bd2>httpServer</span>: <span style=color:#268bd2>server</span>,
});

<span style=color:#268bd2>wsServer</span>.<span style=color:#268bd2>on</span>(<span style=color:#2aa198>&#34;request&#34;</span>, (<span style=color:#268bd2>req</span>) =&gt; {
  <span style=color:#93a1a1;font-style:italic>// chatting 프로토콜을 받는다.
</span><span style=color:#93a1a1;font-style:italic></span>  <span style=color:#859900>var</span> <span style=color:#268bd2>connection</span> = <span style=color:#268bd2>req</span>.<span style=color:#268bd2>accept</span>(<span style=color:#2aa198>&#34;chatting&#34;</span>);

  <span style=color:#268bd2>connections</span>.<span style=color:#268bd2>push</span>(<span style=color:#268bd2>connection</span>);
  <span style=color:#268bd2>console</span>.<span style=color:#268bd2>log</span>(<span style=color:#859900>new</span> <span style=color:#cb4b16>Date</span>() + <span style=color:#2aa198>&#34; Connection accepted. Now &#34;</span> + <span style=color:#268bd2>connections</span>.<span style=color:#268bd2>length</span>);

  <span style=color:#268bd2>connection</span>.<span style=color:#268bd2>on</span>(<span style=color:#2aa198>&#34;message&#34;</span>, (<span style=color:#268bd2>message</span>) =&gt; {
    <span style=color:#859900>if</span> (<span style=color:#268bd2>message</span>.<span style=color:#268bd2>type</span> === <span style=color:#2aa198>&#34;utf8&#34;</span>)
      <span style=color:#93a1a1;font-style:italic>// 브로드캐스팅
</span><span style=color:#93a1a1;font-style:italic></span>      <span style=color:#268bd2>connections</span>.<span style=color:#268bd2>forEach</span>((<span style=color:#268bd2>c</span>) =&gt; <span style=color:#268bd2>c</span>.<span style=color:#268bd2>send</span>(<span style=color:#268bd2>message</span>.<span style=color:#268bd2>utf8Data</span>));
  });

  <span style=color:#268bd2>connection</span>.<span style=color:#268bd2>on</span>(<span style=color:#2aa198>&#34;close&#34;</span>, () =&gt; {
    <span style=color:#268bd2>connections</span> = <span style=color:#268bd2>connections</span>.<span style=color:#268bd2>filter</span>((<span style=color:#268bd2>c</span>) =&gt; <span style=color:#268bd2>c</span> != <span style=color:#268bd2>connection</span>);
    <span style=color:#268bd2>console</span>.<span style=color:#268bd2>log</span>(
      <span style=color:#859900>new</span> <span style=color:#cb4b16>Date</span>() + <span style=color:#2aa198>&#34; Connection disconnected. Now &#34;</span> + <span style=color:#268bd2>connections</span>.<span style=color:#268bd2>length</span>
    );
  });
});

<span style=color:#268bd2>server</span>.<span style=color:#268bd2>listen</span>(<span style=color:#2aa198;font-weight:700>3000</span>, () =&gt; {
  <span style=color:#268bd2>console</span>.<span style=color:#268bd2>log</span>(<span style=color:#2aa198>&#34;Express start to lsten port 3000&#34;</span>);
});
</code></pre></div><h2 id=example>Example</h2><p><a href=https://github.com/atobaum/simple-chatting-websocket-example>Github</a>에 간단한 예제를 올려놓았다.</p><h2 id=reference>Reference</h2><ul><li><a href=https://developer.mozilla.org/ko/docs/WebSockets/Writing_WebSocket_client_applications>MDN</a></li><li><a href=https://hpbn.co/websocket/>High Performance Browser Networking</a></li><li><a href=https://tools.ietf.org/html/rfc6455>RFC6455</a></li></ul></article></div></div></body></html>